on:
  schedule:
    - cron:  '*/15 * * * *'
name: Update Version on Changes
jobs:
  upgrade:
    name: Check for updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Generate Token
        uses: tibdex/github-app-token@v1
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Check for changes
        id: check-changes
        run: |
          TAG=$(git describe --abbrev=0 --tags)
          if [ "$(git show-ref -s main)" == "$(git show-ref -s "$TAG")" ]; then
            VERSION="${TAG#v}"
            echo "::set-output name=VERSION::$(echo "$VERSION")"
          else
            echo "::set-output name=VERSION::$(echo '')"
          fi
      - name: Bump version and push tag
        if: steps.check-changes.outputs.version != ''
        uses: actions-ecosystem/action-bump-semver@v1
        id: bump-semver
        with:
          current_version: ${{ steps.check-changes.outputs.version }}
          level: patch
      - uses: actions-ecosystem/action-push-tag@v1
        with:
          github_token: ${{ steps.generate-token.outputs.token }}
          tag: 'v${{ steps.bump-semver.outputs.new_version }}'
